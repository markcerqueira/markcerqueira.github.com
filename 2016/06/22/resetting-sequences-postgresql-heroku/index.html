<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Resetting Sequences in PostgreSQL on Heroku &middot; mark cerqueira
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/tags.css">
  <link rel="stylesheet" href="/public/css/v1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source%20Sans%20Pro">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">home</a>
    <a class="sidebar-nav-item" href="/about/">about</a>     
    <a class="sidebar-nav-item" href="/archive/">archive</a>
    <a class="sidebar-nav-item" href="/fitness/">fitness</a>
    <a class="sidebar-nav-item" href="/projects/">projects</a>
  </nav>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">mark cerqueira</a>
            <small>well-rounded nerd</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Resetting Sequences in PostgreSQL on Heroku</h1>
  <span class="post-date">22 Jun 2016</span>
  <p>Today <a href="/2016/01/26/evernote-hackathon-report">Glatering</a> – a world-class Rails app with a Postgres database I’m running on Heroku – kicked the bucket! Time to debug… To the Heroku logs!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> 
~ heroku logs --app <span class="o">{</span>app_name<span class="o">}</span>
    ActionView::Template::Error
    PG::UniqueViolation: ERROR: duplicate key value violates unique constraint <span class="s2">"events_pkey"</span>
    Rendered welcome/index.html.erb within layouts/application <span class="o">(</span>324.8ms<span class="o">)</span>
    Completed 500 Internal Server Error <span class="k">in </span>413ms <span class="o">(</span>ActiveRecord: 90.0ms<span class="o">)</span>
    DETAIL: Key <span class="o">(</span>id<span class="o">)=(</span>47<span class="o">)</span> already exists.</code></pre></figure>

<p>Looks like when we were creating a new event object the auto-assigned id for it (which has to be unique) already existed in the database. We were trying to use id 47 when the database had an event with that id already in it. This is weird because that id should be assigned and auto-incremented for us.</p>

<p>So what do we do? <strong>Get Postgres to check itself</strong> a.k.a. reset the value “events_pkey” to a valid value.</p>

<p>To connect to the database, I use my favorite Postgres GUI <a href="https://eggerapps.at/postico/">Postico</a>. All the information you need to connect to the database (e.g. user, password, host, database name) is in the Heroku DATABASE_URL environmental variable in the Settings section of the app dashboard.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> 
~ <span class="nb">echo</span> <span class="nv">$DATABASE_URL</span>
    postgres://<span class="o">{</span>user<span class="o">}</span>:<span class="o">{</span>password<span class="o">}</span>@<span class="o">{</span>host<span class="o">}</span>:<span class="o">{</span>port<span class="o">}</span>/<span class="o">{</span>database<span class="o">}</span></code></pre></figure>

<p>Once connected, click on SQL query, paste the query below (and replace events with the name of the table you’re having issues with), and hit Execute Statement.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> 
SELECT pg_catalog.setval<span class="o">(</span>pg_get_serial_sequence<span class="o">(</span><span class="s1">'events'</span>, <span class="s1">'id'</span><span class="o">)</span>, MAX<span class="o">(</span>id<span class="o">))</span> FROM events;</code></pre></figure>

<p>Boom! Hopefully your database is still in one piece, your Postgres sequence should be reset it, and it won’t generate duplicate ids any more!</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/08/04/changing-progress-bar-color/">
            Changing Progress Bar Spinner Color
            <small>04 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/07/30/ruby-datetime-nsdate/">
            Ruby DateTime to Objective-C NSDate
            <small>30 Jul 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/07/28/concert-review-final-symphony/">
            Concert Review: Final Symphony, San Francisco, 7/28/16
            <small>28 Jul 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
