<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      mark cerqueira &middot; well-rounded nerd
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/tags.css">
  <link rel="stylesheet" href="/public/css/v1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source%20Sans%20Pro">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">home</a>
    <a class="sidebar-nav-item" href="/about/">about</a>     
    <a class="sidebar-nav-item" href="/archive/">archive</a>
    <a class="sidebar-nav-item" href="/fitness/">fitness</a>
    <a class="sidebar-nav-item" href="/projects/">projects</a>
  </nav>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">mark cerqueira</a>
            <small>well-rounded nerd</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/02/14/dont-call-execute-on-asynctask/">
        Don't Call Execute() on AsyncTasks
      </a>
    </h1>

    <span class="post-date">14 Feb 2015</span>

    <style media="screen" type="text/css">

blockquote {
  font-size: 8px;
  margin-top: 10px;
  margin-bottom: 10px;
  margin-left: 50px;
  padding-left: 15px;
  border-left: 3px solid #ccc;
}

</style>

<p>AsyncTasks are pretty useful. But when you submit them for execution, you should know what you’re getting yourself into. Regarding the order of execution for AsyncTasks, <a href="https://developer.android.com/reference/android/os/AsyncTask.html">documentation</a> states:</p>

<blockquote>
"When first introduced, AsyncTasks were executed serially on a single background thread. Starting with DONUT, this was changed to a pool of threads allowing multiple tasks to operate in parallel. Starting with HONEYCOMB, tasks are executed on a single thread to avoid common application errors caused by parallel execution. If you truly want parallel execution, you can invoke executeOnExecutor() with THREAD_POOL_EXECUTOR."
</blockquote>

<p>Cool - seems simple enough. <strong>Calling execute() will queue your AsyncTask onto a single thread. But this can be problematic.</strong> Consider this example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// this might take a long time</span>
<span class="n">AsyncTask</span> <span class="n">fileDownloadTask</span> <span class="o">=</span> <span class="n">getAsyncTaskToDownloadLargeFile</span><span class="o">();</span>
<span class="n">fileDownloadTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// this should not take a long time</span>
<span class="n">AsyncTask</span> <span class="n">databaseQueryTask</span> <span class="o">=</span> <span class="n">getAsyncTaskToMakeQuickQuery</span><span class="o">();</span>
<span class="n">databaseQueryTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span></code></pre></figure>

<p>What’s wrong with this? Your quick database query task we will blocked by your long file download task. This is bad.</p>

<p>How to remedy this? <strong>It’s easy: NEVER use execute() and ALWAYS use executeOnExecutor().</strong></p>

<p>If you need things queued up serially pass SERIAL_EXECUTOR, otherwise pass THREAD_POOL_EXECUTOR. You’ll need to do a little more thinking, but the end result will be a deliberate choice that YOU make.</p>

<p>Why not always just use THREAD_POOL_EXECUTOR to avoid blocking other AsyncTasks? Using the SERIAL_EXECUTOR is an easy way to get the functionality of a <a href="https://en.wikipedia.org/wiki/Barrier_%28computer_science%29">barrier</a> without actually using a barrier. If you need multiple pieces of information fetched before you can do something, you can queue them up on the SERIAL_EXECUTOR. When the last task queued is done, you know the others must have finished running too. That said, you should still call executeOnExecutor(SERIAL_EXECUTOR) instead of execute() in this case!</p>

<p>Happy safe – whether serially or parallel – coding!</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/22/2013-anime-roundup/">
        2013 Anime Roundup
      </a>
    </h1>

    <span class="post-date">22 Jan 2015</span>

    <p>I watched about a metric ton (i.e. 18 series) of anime in 2013. I caught up on some of the hot series from previous seasons so most of the anime I watched I really, really enjoyed. Here’s a breakdown ranging from must-watch series to skips:</p>

<p style="margin-bottom: 8px;"><strong>Your life isn't complete until you watch</strong></p>

<ul>
  <li>Toradora</li>
  <li>Welcome to the NHK</li>
</ul>

<p style="margin-bottom: 8px;"><strong>Great - Definitely worth a watch</strong></p>

<ul>
  <li>Hataraku Maou-sama!</li>
  <li>Knights of Sidonia</li>
  <li>Madoka Magica</li>
  <li>Psycho-Pass</li>
  <li>Sword Art Online (Part 1)</li>
</ul>

<p style="margin-bottom: 8px;"><strong>Good - worth watching if you like the genre</strong></p>

<ul>
  <li>Aldnoah Zero</li>
  <li>Kill la Kill</li>
  <li>Log Horizon</li>
  <li>No Game No Life</li>
  <li>Shingeki no Bahamut</li>
  <li>Sword Art Online 2</li>
</ul>

<p style="margin-bottom: 8px;"><strong>Decent - would recommend these under specific circumstances</strong></p>

<ul>
  <li>Akame ga Kill!</li>
  <li>Angel Beats</li>
  <li>Psycho Pass 2</li>
  <li>Tokyo Ghoul</li>
  <li>Zankyou no Terror</li>
</ul>

<p style="margin-bottom: 8px;"><strong>Skip - I wish I could forget I watched this</strong></p>

<ul>
  <li>Sword Art Online (Part 2)</li>
</ul>

<p>That’s a <strong>rough</strong> breakdown. I found myself moving stuff between the great and good group and just stopped after a while. Depending on your preferences some of these may be more or less appealing. Let me know if you have any questions or want to know my thoughts about any of these series.</p>

<p>On the horizon, I’m very pumped to watch the second season of Aldnoah Zero and Log Horizon!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/14/flexible-android-preferences/">
        Flexible Android Preferences
      </a>
    </h1>

    <span class="post-date">14 Jan 2015</span>

    <p>The recommended way of building a Settings screen in Android is to define preferences in an XML file and then load that file in a PreferenceActivity or PreferenceFragment. But that only works if you know all your preferences at compile-time. And sometimes we don’t know them. Sometimes, we want to be a little more flexible with preference loading.</p>

<p>As expected of Android documentation, we are told, “Your app’s settings are generally pre-determined, although you can still modify the collection at runtime,” but then given no documentation as to how to add or remove things from the collection. Typical.</p>

<p>Fortunately, it’s not difficult to do this. Enter <a href="https://github.com/markcerqueira/flexible_preferences">flexible_preferences</a> – a short Android application that shows you how to do gymnastics with Android Preferences. Tricks include:</p>

<ul>
  <li>Uses a custom layout file so you can show stuff besides the preferences like a loading spinner if you’re fetching preferences over the wire.</li>
  <li>Create preferences without an XML file!</li>
  <li>Hide and show preferences based on input (e.g. hide all other preferences if we toggle one particular preference to the off state).</li>
</ul>

<p>And the best part (besides using the OP LinkedHashMap data structure) is it still leverages Android’s built-in preference functionality, so you get a lot of stuff for free!</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/08/dont-tell-me-to-share-a-secret-key/">
        Don't Tell Me to Share a Secret
      </a>
    </h1>

    <span class="post-date">08 Jan 2015</span>

    <p>My friend Spencer asked me if I could beta test Mini Audicle for iOS. I agreed and asked him if he had any performance monitoring tools set up. Long story short, I ended up integrating <strong>Crittercism</strong> (my favorite crash monitoring tool) into Mini Audicle iOS so he could collect crash data from every user.</p>

<p>One important part of the Crittercism integration process is <strong>uploading dSYMs - debug symbol files</strong>. For release builds, debug symbols are removed to reduce the binary size but this makes crash logs much less useful. Fortunately, dSYM files help us decode (symbolicate) these crash reports. It’s super important to upload dSYMs if you want to make any sense of stack traces.</p>

<p>Fortunately, Crittercism <a href="http://support.crittercism.com/articles/knowledge_base/Uploading-dSYMs-to-Crittercism-automatically/">provides thorough instructions</a> on setting up automatic dSYM upload, but it’s not all sunshine and rainbows.</p>

<!--break-->

<p>The instructions help you set up a script that runs after the build phase is complete.</p>

<div>
	<img style="max-width: 400px; border: 0px solid #000000;" src="/assets/images/posts/2015-01-08/not_the_key.png" />
	<p class="caption-text" style="line-height: 1.5em;  margin-bottom: 24px;"><strong>Something is fishy here...</strong></p>
</div>

<p>What’s wrong with this? <strong>The API key is right there, in plain sight!</strong> As soon as you push this up, your key is available for all to see! While it seems you currently can’t do much damage with the <a href="http://docs.crittercism.com/api/api.html">Crittercism REST API</a>, you probably shouldn’t instruct customers to just put their API key out there for everyone to see. You should AT LEAST warn them about the potential dangers of sharing this key.</p>

<p><strong>Benefit of the doubt time!</strong> I can imagine Crittercism is mostly integrated into enterprise applications that are hosted <strong>privately</strong>. But even in that case, ideally, only your build server, which makes builds for non-developers, would have access to the API key. To that end, Crittercism provides a <a href="https://wiki.jenkins-ci.org/display/JENKINS/Crittercism+dSYM+Plugin">Jenkins plugin</a> eliminating the need to put the API key directly in your source code.</p>

<p>But if you’re a public open source project, do not have a build server, and want to have auto-uploading dSYMs to Crittercism what options do you have? You can still use their method safely by modifying Crittercism’s provided instructions a bit. Here is what Mini Audicle iOS uses:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># only upload during Release builds, otherwise every build will upload a dSYM</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CONFIGURATION</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"Release"</span> <span class="o">]</span>; <span class="k">then</span>
    <span class="c"># put the secret key in this file as an environmental variable</span>
    <span class="k">if</span> <span class="o">[</span> -f ~/.crittercism_keys <span class="o">]</span>; <span class="k">then</span>
		<span class="c"># this is required to inject the environmental variables into</span>
		<span class="c"># the shell spawned by Xcode</span>
        <span class="nb">source</span> ~/.crittercism_keys

        <span class="nv">APP_ID</span><span class="o">=</span><span class="s2">"MY_FIRST_APP_ID_abcdefghi"</span>

		<span class="c"># instead of having your API key here, it is copied in from the</span>
		<span class="c"># environmental varible</span>
        <span class="nv">API_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">MINI_AUDICLE_SECRET_KEY</span><span class="k">}</span>

		<span class="c"># run the script</span>
        <span class="nb">source</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">"</span>/ios/libs/Crittercism/dsym_upload.sh
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"~/.crittercism_keys does not exist. Not uploading dSYM!"</span>
    <span class="k">fi
else
    </span><span class="nb">echo</span> <span class="s2">"Not a Release build so not auto-uploading dSYM file."</span>
<span class="k">fi</span></code></pre></figure>

<p>It requires a little setup (creating the .crittercism_keys file), but we can now <strong>both auto-upload dSYMs and host this project publicly without exposing the API key</strong>. This script also only upload dSYMs for Release builds.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/22/dropbox-and-itunes/">
        Dropbox and iTunes
      </a>
    </h1>

    <span class="post-date">22 Dec 2014</span>

    <p><strong>tl;dr</strong> - If you keep your iTunes library in Dropbox, it’s all sunshine and rainbows until you realize Dropbox is syncing iTunes Library.itl and iTunes Library.xml after EVERY song play or skip.</p>

<p>Putting your iTunes library in Dropbox sounds like a great idea. And for the most part it is. You get your iTunes library on every computer you sync with Dropbox. You add music on one computer, and you get it on the others. Generally, it’s convenient and easy.</p>

<p>The trouble starts when we look at the files that manage our library: <strong>iTunes Library.itl</strong> and <strong>iTunes Library.xml</strong>. Every time a song is touched (played or even skipped), these two files are updated. Every time the files are updated, they are synced to Dropbox.</p>

<div>
	<img class="rounded-corners" style="max-width: 700px; border: 1px solid #000000;" src="/assets/images/posts/2014-12-22/db_sync.png" />
	<p class="caption-text" style="line-height: 1.5em;  margin-bottom: 24px;"><strong></strong></p>
</div>

<p>My iTunes Library (~18,000 songs) itl and xml files are <strong>5.1 MB</strong> and <strong>28.3 MB</strong> respectively. Let’s say the average song is 4 minutes long. If you are listening to my iTunes library for an hour (15 songs), that’s <strong>500 MB worth of file changes that are synced to Dropbox in one hour</strong>! We’re easily talking <strong>gigabytes of bandwidth consumed daily</strong> if you listen for more than a couple of hours. It’s pretty ridiculous.</p>

<p>It’s not a huge deal yet. But still, with bandwidth caps looming in the future, it’s something worth thinking about. So, can we make iTunes in Dropbox less bandwidth hungry?</p>

<!--break-->

<ul>
  <li>
    <p>I could clean up my library and make it smaller. My library is huge and I’m usually only listening to a very small subset of it. That said, it’s nice to have access to my entire library at all times. Especially when I get a hankering for some old jams I haven’t listened to in a while. However, this solution is too easy and we’d learn little if we stopped here, so let’s ignore it.</p>
  </li>
  <li>
    <p>GTFO XML! iTunes only uses the iTunes Library.itl file to organize your entire library. As Apple documents in <a href="http://support.apple.com/en-us/HT201610">this support article</a>, the iTunes Library.xml file makes “your music and playlists available to other applications on your computer” like iPhoto and iMovie. That’s stuff I don’t need. I deleted my iTunes Library.xml file hoping iTunes would happily chug along without it. iTunes loaded fine as expected, but it then quickly recreated the XML file in all it’s 28.3 MB glory.</p>
  </li>
  <li>
    <p>If I can’t make iTunes Library.xml go away, I should be able to tell Dropbox to ignore that file and not sync it right? Wrong! Dropbox’s Selective Sync settings only allow you to ignore folders; there is currently no support for ignoring files. The first link that comes up when I Google “Dropbox ignore file” looks like a feature request posted on Dropbox’s forums that unfortunately 404s. So I made a <a href="https://www.dropboxforum.com/hc/communities/public/questions/201339089-Selective-sync-should-allow-us-to-ignore-specific-files-within-a-folder">new post requesting the feature</a>. For now, you can “hack” file ignore with the steps from this <a href="http://superuser.com/a/757498">Super User answer</a>.</p>
  </li>
</ul>

<div>
	<img class="rounded-corners" style="max-width: 700px; border: 1px solid #000000;" src="/assets/images/posts/2014-12-22/improvement.png" />
	<p class="caption-text" style="line-height: 1.5em;  margin-bottom: 24px;"><strong>Getting better...</strong></p>
</div>

<p><strong>Now that the XML file is no longer synced, syncs are 85% leaner!</strong> But we could do better… if we worked at Apple and could make important engineering decisions. We know a few things:</p>

<ul>
  <li>The itl file that manages our library’s metadata seems to be purposefully obfuscated.</li>
  <li>The new iTunes 12 icon is absolutely hideous.</li>
  <li>The itl file (5.1 MB) has enough information in it to re-generate the XML file (28.3 MB).</li>
  <li>XML is too too verbose. The itl file likely contains some other information given my XML file can be compressed from 28.3 MB to 1.7 MB using the built-in archiver in OS X. That leaves 3.4 MB (5.1 MB - 1.7 MB) of mystery in that file!</li>
</ul>

<p>So let’s use an entry in our iTunes Library.xml file to get an idea of what an entry in the itl file would look like. Here’s a song entry:</p>

<figure class="highlight"><pre><code class="language-xml-cheetah" data-lang="xml+cheetah">&lt;key&gt;Track ID&lt;/key&gt;&lt;integer&gt;21743&lt;/integer&gt;
&lt;key&gt;Name&lt;/key&gt;&lt;string&gt;Dead Sea (Tower of Geddon)&lt;/string&gt;
&lt;key&gt;Artist&lt;/key&gt;&lt;string&gt;Chrono Cross&lt;/string&gt;
&lt;key&gt;Album Artist&lt;/key&gt;&lt;string&gt;Yasunori Mitsuda&lt;/string&gt;
&lt;key&gt;Composer&lt;/key&gt;&lt;string&gt;Yasunori Mitsuda&lt;/string&gt;
&lt;key&gt;Album&lt;/key&gt;&lt;string&gt;Chrono Cross OST&lt;/string&gt;
&lt;key&gt;Genre&lt;/key&gt;&lt;string&gt;Game&lt;/string&gt;
&lt;key&gt;Kind&lt;/key&gt;&lt;string&gt;MPEG audio file&lt;/string&gt;
&lt;key&gt;Size&lt;/key&gt;&lt;integer&gt;7803584&lt;/integer&gt;
&lt;key&gt;Total Time&lt;/key&gt;&lt;integer&gt;190406&lt;/integer&gt;
&lt;key&gt;Disc Number&lt;/key&gt;&lt;integer&gt;2&lt;/integer&gt;
&lt;key&gt;Disc Count&lt;/key&gt;&lt;integer&gt;3&lt;/integer&gt;
&lt;key&gt;Track Number&lt;/key&gt;&lt;integer&gt;15&lt;/integer&gt;
&lt;key&gt;Track Count&lt;/key&gt;&lt;integer&gt;26&lt;/integer&gt;
&lt;key&gt;Year&lt;/key&gt;&lt;integer&gt;1999&lt;/integer&gt;
&lt;key&gt;Date Modified&lt;/key&gt;&lt;date&gt;2011-02-09T04:15:40Z&lt;/date&gt;
&lt;key&gt;Date Added&lt;/key&gt;&lt;date&gt;2011-02-09T04:12:57Z&lt;/date&gt;
&lt;key&gt;Bit Rate&lt;/key&gt;&lt;integer&gt;320&lt;/integer&gt;
&lt;key&gt;Sample Rate&lt;/key&gt;&lt;integer&gt;44100&lt;/integer&gt;
&lt;key&gt;Play Count&lt;/key&gt;&lt;integer&gt;83&lt;/integer&gt;
&lt;key&gt;Play Date&lt;/key&gt;&lt;integer&gt;3502032647&lt;/integer&gt;
&lt;key&gt;Play Date UTC&lt;/key&gt;&lt;date&gt;2014-12-21T23:50:47Z&lt;/date&gt;
&lt;key&gt;Skip Count&lt;/key&gt;&lt;integer&gt;9&lt;/integer&gt;
&lt;key&gt;Skip Date&lt;/key&gt;&lt;date&gt;2013-11-14T02:08:13Z&lt;/date&gt;
&lt;key&gt;Rating&lt;/key&gt;&lt;integer&gt;100&lt;/integer&gt;
&lt;key&gt;Album Rating&lt;/key&gt;&lt;integer&gt;100&lt;/integer&gt;
&lt;key&gt;Album Rating Computed&lt;/key&gt;&lt;true/&gt;
&lt;key&gt;Artwork Count&lt;/key&gt;&lt;integer&gt;1&lt;/integer&gt;
&lt;key&gt;Persistent ID&lt;/key&gt;&lt;string&gt;8633DA1C1A82A603&lt;/string&gt;
&lt;key&gt;Track Type&lt;/key&gt;&lt;string&gt;File&lt;/string&gt;
&lt;key&gt;Location&lt;/key&gt;&lt;string&gt;&lt;!----&gt;.mp3&lt;/string&gt;
&lt;key&gt;File Folder Count&lt;/key&gt;&lt;integer&gt;5&lt;/integer&gt;
&lt;key&gt;Library Folder Count&lt;/key&gt;&lt;integer&gt;1&lt;/integer&gt;</code></pre></figure>

<p>Most of this data doesn’t need to be updated frequently. In fact, only 5 of the 31 values above (Play Count, Play Date, Play Date UTC, Skip Count, Skip Date) would trigger the file changes after playing or skipping a song.</p>

<p>iTunes could break these “volatile” fields into a separate file and use the track ID if it ever needed to match data between the two files. This iTunes Volatile Library.itl file would sync at the current frequency during playback (but it would be smaller in size), while the file containing the other metadata would change and sync less frequently. If keeping this data 100% accurate across your computers isn’t very important, you could even ignore this file using the Dropbox ignore-file-hack.</p>

<div>
	<img style="max-width: 400px; border: 0px solid #000000;" src="/assets/images/posts/2014-12-22/db_fresh.png" />
	<p class="caption-text" style="line-height: 1.5em;  margin-bottom: 24px;"><strong>Dr. Dre - can you makes iTunes the leanest and illest it can be?</strong></p>
</div>

<p>There are other solutions like storing volatile data in iCloud and tying that to your Apple account. Also, if the XML file was still used to manage your library (instead of the obfuscated binary itl file format), you could even store your iTunes Library in git and push and pull changes to the XML file across different computers. How wonderful it would be to resolve a merge conflict in iTunes Library.xml? Dear God – did I play that song 4 times or 6 times!?</p>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page16">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page14">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
