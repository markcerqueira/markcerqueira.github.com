<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Ant, dex, and jars all over &middot; mark cerqueira
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/tags.css">
  <link rel="stylesheet" href="/public/css/v1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source%20Sans%20Pro">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">home</a>
    <a class="sidebar-nav-item" href="/about/">about</a>     
    <a class="sidebar-nav-item" href="/archive/">archive</a>
    <a class="sidebar-nav-item" href="/fitness/">fitness</a>
    <a class="sidebar-nav-item" href="/projects/">projects</a>
  </nav>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">mark cerqueira</a>
            <small>well-rounded nerd</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Ant, dex, and jars all over</h1>
  <span class="post-date">01 May 2013</span>
  <p>We recently added <a href="http://androidannotations.org/">Android Annotations</a> to the Sing Karaoke Android project. Using the annotations has been awesome so far, but it did present an interesting issue when it came to compiling and bundling the proper library in our Ant build script.</p>

<!--break-->

<p>Android Annotations provides two jar files: <em>androidannotations-X.Y.jar</em> used to generate code at compile time and <em>androidannotations-X.Y-api.jar</em> which contains only the code necessary during run time. So for our builds, in addition to the standard <strong>libs</strong> folder used for compilation/runtime, we would compile with a <strong>libs-compiling</strong> folder containing <em>androidannotations-X.Y.jar</em> and then link with a <strong>libs-runtime</strong> folder containing <em>androidannotations-X.Y-api.jar</em>. I deviated a bit from the <a href="https://github.com/excilys/androidannotations/wiki/Building-Project-Ant">recommended setup</a> for where to put these libraries because I wanted the folders containing the libraries to all be treated the same during the Ant build process. The end goal here is:
* <strong>libs</strong> - used during compile time and runtime
* <strong>libs-compiling</strong> - used only during compile time
* <strong>libs-runtime</strong> - used only during runtime</p>

<p>During the compile step, in the javac task we can use the handy classpath attribute to add any extra libraries we need to make the compiler happy (<strong>libs</strong> and <strong>libs-compiling</strong>):</p>

<figure class="highlight"><pre><code class="language-xml-cheetah" data-lang="xml+cheetah">&lt;!-- include all libraries needed for compilation --&gt;
&lt;fileset dir="libs" includes="*.jar"/&gt;
&lt;fileset dir="libs-compiling" includes="*.jar"/&gt;</code></pre></figure>

<p>With this, compilation will succeed. But afterwards, when everything is compiled into a Dalvik Executable (.dex) and packaged into a single .apk file, only the jars in the <strong>libs</strong> folder were getting pulled. So the app would load, but would crash as soon as it tries to use any of the methods in the missing jar libraries. This did not come as much of a shock; the classpath attribute’s scope likely terminates as soon as javac is done. After beating my head against a wall trying to get dex to acknowledge my <strong>libs-runtime</strong> folder, I implemented this <em>solution</em>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># run this command before we execute our Ant build</span>
cp -R -v libs-compiling/ libs/</code></pre></figure>

<figure class="highlight"><pre><code class="language-xml-cheetah" data-lang="xml+cheetah">&lt;!-- TODO fix dex step so we can do this properly --&gt;
&lt;!-- include all libraries needed for compilation --&gt;
&lt;!-- &lt;fileset dir="libs-compiling" includes="*.jar"/&gt; --&gt;

&lt;fileset dir="libs" includes="*.jar"/&gt;</code></pre></figure>

<p>This made me cringe a little inside, especially since we were using the bulkier compile version of Android Annotations and not the slimmer runtime version. Fortunately, I got around to taking care of this as well. At first, I searched the internet and could not find anything that would just let me specify some extra paths for dex. A few solutions had people running the dx command themselves, but after a few failed attempts at copy-and-paste-and-adapt, I started looking elsewhere. Eventually, I just started looking at the default Ant build.xml file that is distributed in the tools folder of the Android SDK. In there was this Ant macro:</p>

<figure class="highlight"><pre><code class="language-xml-cheetah" data-lang="xml+cheetah">&lt;!-- Configurable macro, which allows to pass as parameters output directory,
     output dex filename and external libraries to dex (optional) --&gt;
&lt;macrodef name="dex-helper"&gt;</code></pre></figure>

<p>The first hit when I googled “dex-helper” for some usage tips is a <a href="https://code.google.com/p/android/issues/detail?id=13091">bug report</a> which was fortunately closed in January 2011, but did include an awesome example. So at the end of this adventure, I arrived at a painless solution to the issue of dex running when there are jar files in multiple directories:</p>

<figure class="highlight"><pre><code class="language-xml-cheetah" data-lang="xml+cheetah">&lt;target name="-post-compile"&gt;
  &lt;echo message="Adding external libs to dex lib path via dex-helper"/&gt;

  &lt;dex-helper&gt;
    &lt;external-libs&gt;
      &lt;fileset dir="libs-runtime" includes="*.jar"/&gt;
      &lt;!-- no need to add "libs" as dex already adds it --&gt;
    &lt;/external-libs&gt;
  &lt;/dex-helper&gt;
&lt;/target&gt;</code></pre></figure>

<p>Now we compile with <strong>libs</strong>/<strong>libs-compiling</strong> and run with <strong>libs</strong>/<strong>libs-runtime</strong>!</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/08/04/changing-progress-bar-color/">
            Changing Progress Bar Spinner Color
            <small>04 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/07/30/ruby-datetime-nsdate/">
            Ruby DateTime to Objective-C NSDate
            <small>30 Jul 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/07/28/concert-review-final-symphony/">
            Concert Review: Final Symphony, San Francisco, 7/28/16
            <small>28 Jul 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
